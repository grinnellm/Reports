%##############################################################################
% 
% Author:       Matthew H. Grinnell
% Affiliation:  Pacific Biological Station, Fisheries and Oceans Canada (DFO) 
% Group:        Inshore Assessment Section, Fish Population Assessment Division
% Address:      3190 Hammond Bay Road, Nanaimo, BC, Canada, V9T 6N7
% Contact:      e-mail: matt.grinnell@dfo-mpo.gc.ca | tel: 250.756.7055
% Project:      Herring
% Code name:    ModelSummary.rnw
% Version:      1.0
% Date started: Jun 03, 2016
% Date edited:  Jun 05, 2017
% 
% Overview: TODO: Update
% Generate annual stock assessment summary reports for Pacific herring by region 
% using this skeleton document and:
%   The custom style file: Document/HerringSummary.sty
%   Various R objects from the .RData file generated by '?.R'.
%   Child documents: Document/Variables.rnw, and Document/Context.rnw.
%   Tables and figures inported from R output (*.tex ,and *.pdf, respectively).
% 
% Requirements: 
% Links to the directory that contains output from the R script 'Summary.R',
% and links to the auxiliary text files /Year/Region/*.tex. In addition, links
% to the model output directory.
% 
% Notes: 
% This is a dynamic document (http://yihui.name/knitr/). All of the reports can
% be made at once by sourcing the script 'CompilePDFs.R'
%
%##############################################################################

% TODO: Include tables and figures of input data.

% Set document style and font size
\documentclass[12pt]{article}

% Style file for the data summaries
\usepackage{Document/HerringSummary}

<<loadImage, echo=FALSE, warning=FALSE>>=
# Load package: dynamic documents
require( knitr, quietly=TRUE )
# Select region(s): major (HG, PRD, CC, SoG, WCVI)
if( !exists('regName') )  regName <- "SoG"
# Set the path to the R output, including a trailing separator
rPath <- file.path( "..", "ModelOutput", regName, .Platform$file.sep )
# Load the R image
load( file=file.path(rPath, "Image.RData") )
# Set the path to the region-specific documents for LaTeX
docPath <- file.path( max(yrRange), regName, .Platform$file.sep )
@

% Load R variables, switches, etc
\Sexpr{knit_child('Document/Variables.rnw')}

% Make the title
\title{Pacific herring stock assessment summary for\\\regionName{} \thisYr{}}

% Message
\newcommand{\disclaimer}{
\hrule
\begin{description}
\item[Note] This report includes a synopsis of the stock assessment model, and a summary of results from the final stock assessment for \regionName{} \thisYr{}.
%For complete details, see [ref?].
\end{description} 
}

% Custom text to insert in Context
\newcommand{\theFollowing}{The following is a description of the stock assessment for Pacific herring in the \regionName{} \regionType{} SAR in \thisYr{}}

% Begin the document
\begin{document}

% Generate the title etc
\Sexpr{knit_child('Document/Title.rnw')}

% Context section
\section{Context}

% Bring in stock text for context, with an update form \theFollowing
\Sexpr{knit_child('Document/Context.rnw')}

% Input data section
\section{Input data}

For information about the data used in this assessment, refer to the Pacific herring preliminary data summary for \regionName{} \thisYr{}.
Note that the data used and presented here may differ from the data presented in the preliminary data summary.
The stock assessment model relies of three main annual time series of data:
\begin{enumerate}
  \item Catch from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} (\autoref{figCatchGear});
  \item Spawn index from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} (\autoref{figSpawnIndex}); and
  \item Biological data from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)}, specifically number-at-age (\autoref{figProportionAged}), and weight-at-age (\autoref{figWeightAge}).
\end{enumerate}
We provide tables of these time series in \autoref{appInData}: catch (\autoref{tabCatch}), spawn index (\autoref{tabSpawn}), number-at-age (\autoref{tabNumAged}), and weight-at-age (\autoref{tabWeight}).

% Stock assessment model section
\section{Stock assessment model}

The following is adapted from CSAS \citeyearpar{CSAS2016a}.
Pacific Herring abundance is currently assessed using a statistical catch-age model.
The catch-age model is fit to commercial catch data, proportion-at-age data, and a fishery-independent spawning biomass index to estimate biomass, recruitment, and to generate 1-year forecasts of spawning biomass (\citealt{MartellEtal2011}, CSAS \citeyear{CSAS2015b}).
Different versions of the model are fit, respectively, to data for the \Sexpr{length(allRegions$major)} major SARs, and the \Sexpr{length(allRegions$minor)} minor SARs.
A revised catch-age model was introduced for BC herring assessments in 2006 \citep{HaistSchweigert2006}; the model design has since undergone several iterations that have re-structured various model components, and addressed issues identified during peer-review.
One major change introduced in 2011 \citep{MartellEtal2011} was setting the model to estimate the dive survey spawn index scaling parameter $q_{2}$, rather than keeping it fixed at $q_{2}=1.0$, as was done in previous assessment models.
Note that there are two spawn index scaling parameters: the surface survey spawn index scaling parameter $q_{1}$ covers the period \Sexpr{qYrs$q1}, and the dive survey spawn index scaling parameter $q_{2}$ covers the period \Sexpr{qYrs$q2}.
Another major change introduced in 2011 was to make the fishery cut-offs in the harvest control rule dependent on the model's most recent estimate of unfished spawning biomass $\mli{SB}_{0}$ (i.e., cease fishing when the stock is estimated to be below $0.25 \cdot \mli{SB}_{0}$).
In previous model iterations, the fishery cut-offs were fixed at absolute biomass levels estimated in 1996 \citep{SchweigertEtal1997}.
Throughout this document, the term Assessment Model 1 (AM1) describes the more recent management procedure (MP), which estimates $q_{1}$ and $q_{2}$ using informative priors, and estimates fishery cut-offs.
Assessment Model 2 (AM2) refers to an approximation of the historical MP which estimates $q_{1}$, fixes $q_{2}=1.0$, and fixes fishery cut-offs at 1996 levels.

% Model output section
\section{Model output}

Model estimates of spawn index scaling parameters $q$ are indicated in \autoref{tabQPars}.
Model estimates of unfished biomass $\mli{SB}_{0}$, and projected spawning biomass assuming no fishing in \Sexpr{max(yrRange)+1} $\mli{SB}_{\Sexpr{max(yrRange)+1}}$ are indicated in \autoref{tabBPars}.
An overview of model output for AM1 and AM2 is provided in \autoref{figStoryboardAM1} and \autoref{figStoryboardAM2}, respectively.

% Start a new page, and then place all the figures and tables
\newpage

\begin{table}
\centering
\caption{Pacific herring stock assessment regions (SARs) in British Columbia.} 
\begin{tabular}{lll}
\toprule
\inputsp{\Sexpr{noquote(rPath)}Regions.tex}
\end{tabular}
\label{tabRegions}
\end{table}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{BC.pdf}
\caption{Boundaries for the British Columbia Pacific herring stock assessment regions (SARs): there are \Sexpr{length(allRegions$major)} major SARs (\Sexpr{PasteNicely(allRegions$major)}), and \Sexpr{length(allRegions$minor)} minor SARs (\Sexpr{PasteNicely(allRegions$minor)}).
Units: kilometres (km).}
\label{figBC}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{Region.pdf}
\caption{Boundaries for the \regionName{} \regionType{} stock assessment region (SAR; thick dashed lines), and associated Statistical Areas (SA; thin solid lines).
Units: kilometres (km).}
\label{figRegion}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{CatchGear.pdf}
\caption{Time series of total landed catch in thousands of metric tonnes ($\text{t} \times 10^{3}$) of Pacific herring by gear type from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} in the \regionName{} \regionType{} stock assessment region (SAR). 
\legendPeriod{}}
\label{figCatchGear}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnIndex.pdf}
\caption{Time series of spawn index in thousands of metric tonnes ($\text{t} \times 10^{3}$) for Pacific herring from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} in the \regionName{} \regionType{} stock assessment region (SAR).
\qPeriods{}
\spawnIndex{}}
\label{figSpawnIndex}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{ProportionAged.pdf}
\caption{Time series of observed proportion-at-age (a) and number aged in thousands (b) of Pacific herring from \Sexpr{min(yrRange)} to \thisYr{} in the \regionName{} \regionType{} stock assessment region (SAR). 
The black line is the mean age, and the shaded area is the approximate \Sexpr{ciLevel*100}\% distribution. 
\seineSamples{}
\plusGroup{}}
\label{figProportionAged}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{WeightAge.pdf}
\caption{Time series of weight-at-age in kilograms (kg) for age-\Sexpr{ageShow} (circles) and \Sexpr{nRoll}-year running mean weight-at-age (lines) for Pacific herring from \Sexpr{min(yrRange)} to \thisYr{} in the \regionName{} \regionType{} stock assessment region (SAR).
Lines show \Sexpr{nRoll}-year running means for age-\Sexpr{min(ageRange)} to age-\Sexpr{max(ageRange)} herring (incrementing higher from the lowest line); the thick black line highlights age-\Sexpr{ageShow} herring.
Missing weight-at-age values (i.e., years where there are no biological samples) are imputed using one of two methods: missing values at the beginning of the time series are imputed by extending the first non-missing value backwards; other missing values are imputed as the mean of the previous \Sexpr{nRoll} years.
\seineSamples{}
\plusGroup{}}
\label{figWeightAge}
\end{figure}

\begin{table}
\centering
\caption{Spawn index scaling parameters $q$, for Pacific herring stock assessment models 1 and 2 (AM1 and AM2, respectively) in the \regionName{} \regionType{} stock assessment region (SAR).
\qPeriods{}
Lower and upper estimates indicate the \Sexpr{ciLevel*100}\% credible interval.
Legend: $q_{1}$ and $q_{2}$ are the surface and dive spawn index scaling parameters, respectively.
Note that we refer to setting $q_{2} = 1$ in AM2, but in practice this is implemented as $q_{2} \sim \mathcal{N}(\mu,\,\sigma)$, where $\mathcal{N}$ is a normal distribution with mean $\mu = 1.0$, and standard deviation $\sigma = 0.01$.}
\begin{tabular}{lllrrr}
\toprule
& & & \multicolumn{3}{c}{Estimate}\\
\cmidrule{4-6}
\inputsp{\Sexpr{noquote(rPath)}QPars.tex}
\end{tabular}
\label{tabQPars}
\end{table}

\begin{table}
\centering
\caption{Spawning biomass in thousands of tonnes ($\text{t} \times 10^{3}$) for Pacific herring stock assessment models 1 and 2 (AM1 and AM2, respectively) in the \regionName{} \regionType{} stock assessment region (SAR).
Lower and upper estimates indicate the \Sexpr{ciLevel*100}\% credible interval.
Legend: $\mli{SB}_{0}$ is unfished biomass, and $\mli{SB}_{\Sexpr{max(yrRange)+1}}$ is projected spawning biomass assuming no fishing in \Sexpr{max(yrRange)+1}.}
\begin{tabular}{llrrr}
\toprule
& & \multicolumn{3}{c}{Estimate ($\text{t} \times 10^{3}$)}\\
\cmidrule{3-5}
\inputsp{\Sexpr{noquote(rPath)}BPars.tex}
\end{tabular}
\label{tabBPars}
\end{table}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{StoryboardAM1.pdf}
\caption{Model output for Pacific herring in the \regionName{} \regionType{} stock assessment region (SAR) for stock assessment model 1 (AM1).
Panel (a): model fit to time series of scaled spawn survey data in thousands of metric tonnes ($\text{t} \times 10^{3})$.
\qPeriods{}
The spawn survey data (i.e., spawn index) is scaled to abundance via the spawn survey scaling parameter $q$.
%: surface survey spawn index scaling parameter $q_{1} = \Sexpr{qVals$q1$AM2}$; and dive survey spawn index scaling parameter $q_{2} = \Sexpr{qVals$q2$AM2}$.
Panel (b): reconstructed number of age-\Sexpr{ageRec} recruits in millions.
Circles with vertical lines indicate medians and \Sexpr{ciLevel*100}\% credible intervals, respectively.
Panel (c): posterior estimates of instantaneous natural mortality.
Line and shaded area indicate the median and \Sexpr{ciLevel*100}\% credible interval, respectively.
Panel (d): posterior estimate of spawning biomass ($\mli{SB}_{t}$) for each year $t$ in thousands of metric tonnes ($\text{t} \times 10^{3}$).
Line and shaded area indicate median and \Sexpr{ciLevel*100}\% credible interval, respectively.
Also shown is unfished biomass ($\mli{SB}_0$) at far left, and projected spawning biomass assuming no fishing ($\mli{SB}_{\Sexpr{max(yrRange)+1}}$) at the far right: circles with vertical lines indicate medians and \Sexpr{ciLevel*100}\% credible intervals, respectively.
Time series of vertical lines indicates commercial catch, excluding spawn-on-kelp (SOK).}
\label{figStoryboardAM1}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{StoryboardAM2.pdf}
\caption{Model output for Pacific herring in the \regionName{} \regionType{} stock assessment region (SAR) for stock assessment model 2 (AM2).
See the detailed description in \autoref{figStoryboardAM1}.}
\label{figStoryboardAM2}
\end{figure}

% Start a new page for appendices
\newpage

% Start the appendices
\begin{appendices}

% Restart table and figure numbering (Ax)
\setcounter{table}{0}
\renewcommand{\thetable}{A\arabic{table}}

% Input data section
\section{Input data}\label{appInData}

\FloatBarrier
\begin{longtable}{rrrr}
\caption{Pacific herring catch in thousands of metric tonnes ($\text{t} \times 10^{3}$) by Period from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} in the \regionName{} \regionType{} stock assessment region (SAR).
\legendPeriod{}}\\
\toprule
& \multicolumn{3}{c}{Catch ($\text{t} \times 10^{3}$) by Period}\\
\cmidrule{2-4}
\Sexpr{noquote(namesCatch)}\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{4}{c}{\emph{\tablename\ \thetable{} continued}}\\
& \multicolumn{3}{c}{Catch ($\text{t} \times 10^{3}$) by Period}\\
\cmidrule{2-4}
\Sexpr{noquote(namesCatch)}\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}Catch.tex}%
\label{tabCatch}
\end{longtable}
\FloatBarrier

\FloatBarrier
\begin{longtable}{rrl}
\caption{Pacific herring spawn index in thousands of metric tonnes ($\text{t} \times 10^{3}$) from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} in the \regionName{} \regionType{} stock assessment region (SAR).
\qPeriods{}
\spawnIndex{}}\\
\toprule
\Sexpr{noquote(namesSpawn)}\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{3}{c}{\emph{\tablename\ \thetable{} continued}}\\
\Sexpr{noquote(namesSpawn)}\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}Spawn.tex}%
\label{tabSpawn}
\end{longtable}
\FloatBarrier

\FloatBarrier
\begin{longtable}{rrrrrrrrrrr}
\caption{Pacific herring number-at-age from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} in the \regionName{} \regionType{} stock assessment region (SAR).
\legendPeriod{}
\plusGroup{}}\\
\toprule
& & \multicolumn{\Sexpr{length(ageRange)}}{c}{Number-at-age}\\
\cmidrule{3-\Sexpr{length(ageRange)+2}}
\Sexpr{noquote(namesNumAged)}\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{11}{c}{\emph{\tablename\ \thetable{} continued}}\\
& & \multicolumn{\Sexpr{length(ageRange)}}{c}{Number-at-age}\\
\cmidrule{3-\Sexpr{length(ageRange)+2}}
\Sexpr{noquote(namesNumAged)}\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}NumAged.tex}%
\label{tabNumAged}
\end{longtable}
\FloatBarrier

\FloatBarrier
\begin{longtable}{rrrrrrrrrr}
\caption{Pacific herring weight-at-age in kilograms (kg) from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} in the \regionName{} \regionType{} stock assessment region (SAR).
\seineSamples{}
\plusGroup{}}\\
\toprule
& \multicolumn{\Sexpr{length(ageRange)}}{c}{Weight-at-age (kg)}\\
\cmidrule{2-\Sexpr{length(ageRange)+1}}
\Sexpr{noquote(namesWeight)}\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{10}{c}{\emph{\tablename\ \thetable{} continued}}\\
& \multicolumn{\Sexpr{length(ageRange)}}{c}{Weight-at-age (kg)}\\
\cmidrule{2-\Sexpr{length(ageRange)+1}}
\Sexpr{noquote(namesWeight)}\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}Weight.tex}%
\label{tabWeight}
\end{longtable}
\FloatBarrier

% End the appendices
\end{appendices}

% References section
\bibliographystyle{Document/CJFAS}
\addcontentsline{toc}{section}{\refname}\bibliography{Document/HerringSummary}

% Fin
\end{document}
