%##############################################################################
% 
% Author:       Matthew H. Grinnell
% Affiliation:  Pacific Biological Station, Fisheries and Oceans Canada (DFO) 
% Group:        Inshore Assessment Section, Fish Population Assessment Division
% Address:      3190 Hammond Bay Road, Nanaimo, BC, Canada, V9T 6N7
% Contact:      e-mail: matt.grinnell@dfo-mpo.gc.ca | tel: 250.756.7055
% Project:      Herring
% Code name:    DataSummaryJS.rnw
% Version:      1.0
% Date started: Jun 03, 2016
% Date edited:  Jun 05, 2017
% 
% Overview: 
% Generate annual preliminary data summary reports for Pacific herring for
% Johnstone Strait (JS) using this skeleton document and:
%   The custom style file: Document/HerringSummary.sty
%   Various R objects from the .RData file generated by 'Summary.R'.
%   Child documents: Document/Variables.rnw, and Document/Context.rnw.
%   Tables and figures inported from R output (*.tex ,and *.pdf, respectively).
%   Text files in /{Year}/{Region}/*.tex.
% 
% Requirements: 
% Links to the directory that contains output from the R script 'Summary.R',
% and links to the auxiliary text files /Year/Region/*.tex.
% 
% Notes: 
% This is a dynamic document (http://yihui.name/knitr/). All of the reports can
% be made at once by sourcing the R script 'MakeDataSummaries.R'
%
%##############################################################################

% Set document style and font size
\documentclass[12pt]{article}

% Style file for the data summaries
\usepackage{Document/HerringSummary}

<<loadImage, echo=FALSE, warning=FALSE>>=
# Load package: dynamic documents
require( knitr, quietly=TRUE )
# Select region(s): major (HG, PRD, CC, SoG, WCVI); or minor (A27, A2W, JS)
if( !exists('regName') )  regName <- "JS"
# Set the path to the R output, including a trailing separator
rPath <- file.path( "..", "DataSummaries", regName, .Platform$file.sep )
# Load the R image
load( file=file.path(rPath, "Image.RData") )
# Set the path to the region-specific documents for LaTeX
docPath <- file.path( max(yrRange), regName, .Platform$file.sep )
@

% Initialize switches; set to TRUE/FALSE in R based on conditions in the region
\newtoggle{spawnByLoc}  % Show spawn locations
\Sexpr{tfSpawnByLoc}
\newtoggle{spawnByLocXY}  % Show spawn locations with X and Y
\Sexpr{tfSpawnByLocXY}

% Load R variables, switches, etc
\Sexpr{knit_child('Document/VariablesJS.rnw')}

% TODO: Wording in text and captions for 'tabBioNum' and 'tabBioTypeNum' re showing 'Representative' biological samples only (once the R script is updated). Use the command '\repSamples' below. This could also include the figure 'BioLocations.pdf' (Note that this creates issues with WCVI because of the cast-net biosamples, which are not representative, but are included in the data summary.)
% TODO: Active voice!

% Make the title
\title{Pacific herring data summary for\\\regionName{}}

% Message
\newcommand{\disclaimer}{
\hrule
\begin{description}
\item[Disclaimer] The \regionName{} \regionType{} is outside the boundary of the \Sexpr{length(allRegions$major)} major stock areas, and there are no annual survey programs for this area. In addition, note that Sections 132 and 135 are included in this report, but these two Sections are officially included in the Strait of Georgia major stock area.
\end{description} 
}

% Custom text to insert in Context
\newcommand{\theFollowing}{The following is a description of data collected for Pacific herring in the \regionName{} \regionType{}}

% Begin the document
\begin{document}

% Generate the title etc
\Sexpr{knit_child('Document/Title.rnw')}

% Context section
\section{Context}

% Bring in stock text for context, with an update form \theFollowing
\Sexpr{knit_child('Document/ContextJS.rnw')}

% Catch and biological samples section
\section{Catch and biological samples}

% Bring in custom text for catch and biological samples
The total landed commercial catch of Pacific herring from all fisheries in \thisYr{} in the \regionName{} \regionType{} was \Sexpr{format(tCatchThisYr, big.mark=",", digits=0, scientific=FALSE)}\,t, which is \Sexpr{tCatchDir} last year (\autoref{figCatchGear}, \autoref{tabCatch}).
The total harvested spawn on kelp (SOK) in \thisYr{} in the \regionName{} \regionType{} was \Sexpr{format(tSoKThisYr$Harvest, big.mark=",", digits=0, scientific=FALSE)}\,lb (\autoref{tabHarvestSOK}). 

In \thisYr{}, \Sexpr{nSampThisYr} Pacific herring biological samples were collected and processed for the \regionName{} \regionType{} (\autoref{tabBioNum}), and a total of \Sexpr{numAgedThisYr} Pacific herring were aged in \thisYr{}. 
\iftoggle{numPropWtAge}{There are differences between biological data collected from two sampling protocols regarding the number-, proportion-, and weight-at-age for Pacific herring in \thisYr{} in the \regionName{} \regionType{} (\autoref{tabDeltaNumAgeYr}, \autoref{tabDeltaPropAgeYr}, and \autoref{tabDeltaWtAgeYr}, respectively).
The nearshore sampling program is a multi-year pilot study (using cast nets), therefore only biological data from the seine samples were used for the purposes of stock assessment.}{\unskip}
\iftoggle{biosamples}{The locations in which the biological samples were collected are presented in \autoref{figBioLocations}.}{\unskip}
Included herein are biological summaries of observed proportion-, number-, and weight-at-age (\autoref{figProportionAged}, \autoref{tabPropAgedYearTab}, and \autoref{figWeightAge}, respectively).
\seineSamples{}

% Spawn survey data section
\section{Spawn survey data}

Since 2006, the Musgamagw Dzawada'enuxw Nations have been conducting underwater herring spawn surveys around the Broughton Archipelago and Kingcome Inlet within their traditional territory, funded through AFS.
Prior to 2006, most of the spawn surveys were surface surveys.

\iftoggle{spawnByLoc}{Herring spawn surveys were conducted at \Sexpr{nSpawnLoc} location\Sexpr{ifelse(nSpawnLoc>1, "s", "")} in \thisYr{} in the \regionName{} \regionType{} (\autoref{tabSpawnByLoc}\iftoggle{spawnByLocXY}{, and \autoref{figSpawnByLoc}}{\unskip}).}
{No spawn surveys were conducted in \thisYr{} in the \regionName{} \regionType{} SAR.}
A summary of spawn from the last decade (\Sexpr{unique(spawnDecade$Decade)}) is shown in \autoref{figSpawnDecade}.
Spawn surveys are conducted to estimate the spawn length, width, number of egg layers, and substrate type, and these data are used to estimate the index of spawning biomass (i.e., the spawn index; \autoref{figSpawnLength}, \autoref{figSpawnWidth}, \autoref{figSpawnLayers}, \autoref{figSpawnIndexPercent}, and \autoref{tabSpawnYrTab}). 
\spawnIndex{}
Therefore, these data do not represent model estimates of spawning biomass, and are considered the minimum observed spawning biomass derived from egg counts.
\qPeriods{}

Some herring Sections contribute more than others to the total spawn index, and the percentage contributed by Section varies yearly (\autoref{figSpawnIndexPercent}b, \autoref{figSpawnPercentPanel}). 
For example, in \thisYr{}, Section \Sexpr{pSpawnThisYr$Section} contributed the most to the spawn index (\Sexpr{pSpawnThisYr$Percent}\%). 
As with Sections, some \Sexpr{spawnIndexGroupName$a}s contribute more than others to the total spawn index (\autoref{figSpawnIndexPercent}c, \autoref{figSpawnPercentGrid}).

% Start a new page, and then place all the figures and tables
\newpage

\begin{figure}
\centering
\includegraphics[width=\linewidth]{Region.pdf}
\caption{Boundaries for the \regionName{} \regionType{} (thick dashed lines), and associated Statistical Areas (SA; thin solid lines).
\darkPolys{}
Units: kilometres (km).}
\label{figRegion}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{CatchGear.pdf}
\caption{Time series of total landed catch in metric tonnes (t) of Pacific herring by gear type from \Sexpr{min(yrRange)} to \thisYr{} in the \regionName{} \regionType{}. 
\legendPeriod{}}
\label{figCatchGear}
\end{figure}

\iftoggle{biosamples}{
\begin{figure}
\centering
\includegraphics[width=\linewidth]{BioLocations.pdf}
\caption{Location and type of Pacific herring biological samples collected in \thisYr{} in the \regionName{} \regionType{} (thick dashed lines), and associated Section\Sexpr{ifelse(length(unique(areas$Section))>1, "s", "")} (Sec; thin solid lines).
\darkPolys{}
Units: kilometres (km).}
\label{figBioLocations}
\end{figure}
}{\unskip}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{ProportionAged.pdf}
\caption{Time series of observed proportion-at-age (a) and number aged in thousands (b) of Pacific herring from \Sexpr{min(yrRange)} to \thisYr{} in the \regionName{} \regionType{}. 
The black line is the mean age, and the shaded area is the approximate \Sexpr{ciLevel*100}\% distribution. 
\seineSamples{}
\plusGroup{}}
\label{figProportionAged}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{WeightAge.pdf}
\caption{Time series of weight-at-age in grams (g) for age-\Sexpr{ageShow} (circles) and \Sexpr{nRoll}-year running mean weight-at-age (lines) for Pacific herring from \Sexpr{min(yrRange)} to \thisYr{} in the \regionName{} \regionType{}. 
Lines show \Sexpr{nRoll}-year running means for age-\Sexpr{min(ageRange)} to age-\Sexpr{max(ageRange)} herring (incrementing higher from the lowest line); the thick black line highlights age-\Sexpr{ageShow} herring.
Missing weight-at-age values (i.e., years where there are no biological samples) are imputed using one of two methods: missing values at the beginning of the time series are imputed by extending the first non-missing value backwards; other missing values are imputed as the mean of the previous \Sexpr{nRoll} years.
\seineSamples{}
\plusGroup{}}
\label{figWeightAge}
\end{figure}

\iftoggle{spawnByLoc}{
\FloatBarrier
\begin{longtable}{rrrlr}
\caption{Pacific herring spawn survey location\Sexpr{ifelse(nrow(spawnByLoc)>1, "s", "")}, and spawn index in metric tonnes (t) in \thisYr{} in the \regionName{} \regionType{}.
\spawnIndex{}
Missing spawn index values (i.e., NA) indicate incomplete spawn surveys.}\\
\toprule
\Sexpr{noquote(namesSpawnLoc)}\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{5}{c}{\emph{\tablename\ \thetable{} continued}}\\
\Sexpr{noquote(namesSpawnLoc)}\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}SpawnByLoc.tex}%
\label{tabSpawnByLoc}
\end{longtable}
\FloatBarrier

\iftoggle{spawnByLocXY}{
\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnByLoc.pdf}
\caption{Pacific herring spawn survey location\Sexpr{ifelse(nrow(spawnByLoc)>1, "s", "")}, and spawn index in metric tonnes (t) in \thisYr{} in the \regionName{} \regionType{} (thick dashed lines), and associated Section\Sexpr{ifelse(length(unique(areas$Section))>1, "s", "")} (Sec; thin solid lines).
\spawnIndex{}
Missing spawn index values (grey circles) indicate incomplete spawn surveys.
\darkPolys{}
Units: kilometres (km).}
\label{figSpawnByLoc}
\end{figure}
}{}
}{\unskip}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnDecade.pdf}
\caption{Pacific herring spawn survey location\Sexpr{ifelse(nrow(spawnByLoc)>1, "s", "")}, mean spawn index in metric tonnes (t), and spawn frequency from \Sexpr{unique(spawnDecade$Decade)} in the \regionName{} \regionType{} (thick dashed lines), and associated Section\Sexpr{ifelse(length(unique(areas$Section))>1, "s", "")} (Sec; thin solid lines).
\spawnIndex{}
Missing spawn index values (grey circles) indicate incomplete spawn surveys.
%Note that the mean excludes years when no spawn was reported.
\darkPolys{}
Units: kilometres (km).}
\label{figSpawnDecade}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnLength.pdf}
\caption{Time series of total spawn length in metres (m) for Pacific herring from \Sexpr{firstYrFig} to \thisYr{} in the \regionName{} \regionType{}. 
\trendLine{}
\qPeriods{}}
\label{figSpawnLength}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnWidth.pdf}
\caption{Time series of mean spawn width in metres (m) for Pacific herring from \Sexpr{firstYrFig} to \thisYr{} in the \regionName{} \regionType{}. 
\trendLine{}
\qPeriods{}}
\label{figSpawnWidth}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnLayers.pdf}
\caption{Time series of mean number of spawn layers for Pacific herring from \Sexpr{firstYrFig} to \thisYr{} in the \regionName{} \regionType{}. 
\trendLine{}
\qPeriods{}}
\label{figSpawnLayers}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnIndexPercent.pdf}
\caption{Time series of spawn index in metric tonnes (t) for Pacific herring from \Sexpr{firstYrFig} to \thisYr{} in the \regionName{} \regionType{} (a), as well as percent contributed by \Sexpr{spawnIndexGroupName$b}, and Section (b, \& c, respectively). 
\trendLine{}
\qPeriods{}
\spawnIndex{}
\noteSects{}
\Sexpr{spawnIndexGroupLegend}}
\label{figSpawnIndexPercent}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnPercentPanel.pdf}
\caption{Time series of percent of spawn index by Section for Pacific herring from \Sexpr{firstYrFig} to \thisYr{} in the \regionName{} \regionType{}. 
The year \thisYr{} has a darker bar to facilitate interpretation.
\qPeriods{}
\noteSects{}
\spawnIndex{}}
\label{figSpawnPercentPanel}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\linewidth]{SpawnPercentGrid.pdf}
\caption{Time series of percent of spawn index by \Sexpr{spawnIndexGroupName$b} and Section for Pacific herring from \Sexpr{firstYrFig} to \thisYr{} in the \regionName{} \regionType{}. 
\qPeriods{}
\noteSects{}
\spawnIndex{}
\Sexpr{spawnIndexGroupLegend}}
\label{figSpawnPercentGrid}
\end{figure}

% Start a new page for appendices
\newpage

% Start the appendices
\begin{appendices}

% Restart table and figure numbering (Ax)
\setcounter{table}{0}
\renewcommand{\thetable}{A\arabic{table}}

% Input data section
\section{Timeseries data}\label{appInData}

\FloatBarrier
\begin{longtable}{rrrrr}
\caption{Pacific herring catch in thousands of metric tonnes ($\text{t} \times 10^{3}$) by Period from \Sexpr{min(yrRange)} to \Sexpr{max(yrRange)} in the \regionName{} \regionType{}.
\legendPeriod{}
\SoG{}}\\
\toprule
& \multicolumn{3}{c}{Catch ($\text{t} \times 10^{3}$) by Period} &\\
\cmidrule{2-4}
Year & Gear1 & Gear2 & Gear3 & SoG\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{5}{c}{\emph{\tablename\ \thetable{} continued}}\\
& \multicolumn{3}{c}{Catch ($\text{t} \times 10^{3}$) by Period} &\\
\cmidrule{2-4}
Year & Gear1 & Gear2 & Gear3 & SoG\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}CatchADMB.tex}%
\label{tabCatch}
\end{longtable}
\FloatBarrier

\FloatBarrier
\begin{longtable}{rrr}
\caption{Total harvested Pacific herring spawn on kelp (SOK) in pounds (lb) from \Sexpr{firstYrTab} to \thisYr{} in the \regionName{} \regionType{}.
\SoG{}}\\
\toprule
Year & Harvest (lb) & SoG\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{3}{c}{\emph{\tablename\ \thetable{} continued}}\\
Year & Harvest (lb) & SoG\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}HarvestSOK.tex}%
\label{tabHarvestSOK}
\end{longtable}
\FloatBarrier

\FloatBarrier
\begin{longtable}{rrrrr}
\caption{Number of Pacific herring biological samples processed from \Sexpr{firstYrTab} to \thisYr{} in the \regionName{} \regionType{}.
\sampleSize{}
\SoG{}}\\
\toprule
& \multicolumn{3}{c}{Number of samples} &\\
\cmidrule{2-4}
Year & Commercial & Test & Total & SoG\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{5}{c}{\emph{\tablename\ \thetable{} continued}}\\
& \multicolumn{3}{c}{Number of samples} &\\
\cmidrule{2-4}
Year & Commercial & Test & Total & SoG\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}BioNum.tex}%
\label{tabBioNum}
\end{longtable}
\FloatBarrier

\FloatBarrier
\begin{longtable}{rrrrrrrrrr}
\caption{Observed proportion-at-age for Pacific herring from \Sexpr{firstYrTab} to \thisYr{} in the \regionName{} \regionType{}. 
\plusGroup{}}\\
\toprule
& \multicolumn{\Sexpr{length(ageRange)}}{c}{Proportion-at-age}\\
\cmidrule{2-\Sexpr{length(ageRange)+1}}
Year & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{10}{c}{\emph{\tablename\ \thetable{} continued}}\\
& \multicolumn{\Sexpr{length(ageRange)}}{c}{Proportion-at-age}\\
\cmidrule{2-\Sexpr{length(ageRange)+1}}
Year & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}PropAgedYearTab.tex}%
\label{tabPropAgedYearTab}
\end{longtable}
\FloatBarrier

\FloatBarrier
\begingroup
\setlength{\LTleft}{-20cm plus -1fill}
\setlength{\LTright}{\LTleft}
\begin{longtable}{rrrrrr}
\caption{Summary of spawn survey data from \Sexpr{firstYrTab} to \thisYr{} in the \regionName{} \regionType{}. 
\qPeriods{}
\spawnIndex{}
\SoG{}
Missing values (i.e., NA) indicate incomplete spawn surveys.
Units: metres (m), and metric tonnes (t).}\\
\toprule
Year & Total length (m) & Mean width (m) & Mean number of egg layers & Spawn index (t) & SoG\\ 
\midrule
\endfirsthead
\toprule
\multicolumn{6}{c}{\emph{\tablename\ \thetable{} continued}}\\
Year & Total length (m) & Mean width (m) & Mean number of egg layers & Spawn index (t) & SoG\\ 
\midrule
\endhead
\bottomrule
\endfoot
\bottomrule
\endlastfoot
\inputsp{\Sexpr{noquote(rPath)}SpawnYrTab.tex}%
\label{tabSpawnYrTab}
\end{longtable}
\endgroup
\FloatBarrier

% End the appendices
\end{appendices}

% Fin
\end{document}
